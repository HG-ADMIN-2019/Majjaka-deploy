{% extends 'root/base.html' %}
{% load static %}

{% block title %} Supplier Management (Admin Tool) {% endblock %}
{% block maincontent %}

<div class="container-fluid">
    <div class="mep-form_wrapper">

        <div class="d-flex justify-content-between">
            <h3>Supplier Management</h3>
            <div>
                 <button class="btn btn-outline-primary"  title="Extract" onclick="location.href='{% url 'eProc_Admin_Tool:extract_supplier_template' %}'"type="button">
                    <i class="fas fa-download"></i> download template
                </button>
                <button class="btn btn-outline-primary"  title="Extract" onclick="location.href='{% url 'eProc_Basic_Settings:extract_supplier_data' %}'"type="button">
                    <i class="fas fa-download"></i> extract
                </button>
                <button class="btn btn-outline-primary" id="basic_save_upld_redirect" onclick="onclick_upload_button()">
                    <i class="fas fa-cloud-upload-alt"></i> 
                    upload data
                </button>
                <button class="btn btn-primary" onclick="window.open(href = '{% url 'eProc_Admin_Tool:sup_details_page' None %}')">
                    <i class="fas fa-user-plus"></i> 
                    Create Supplier
                </button>
                
            </div>
        </div>

        <hr>

        <div class="card card-shadow-1">
            <div class="card-body">
                <div class="elements-space-between">
                    <div></div>
                     <div> <span class="badge help-text-badge help-text-star-search"></span></div>
                </div>
                <form method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md">
                            <label for="">First Name</label>
                            <input type="text" class="form-control check_for_search" id="name1" name="name1" >
                        </div>
                        <div class="col-md">
                            <label for="">Last Name</label>
                            <input type="text" class="form-control check_for_search" id="name2" name="name2">
                        </div>
                        <div class="col-md">
                            <label for="">Supplier Number</label>
                            <input type="text" class="form-control check_for_search" id="supplier_id" name='supplier_id'>
                        </div>
                        <div class="col-auto my-1">
                            <button class="button-search-users btn btn-primary" type="submit"
                                    title="Please click to get the search details!" onclick="reload()"><i class="fas fa-search"></i> search
                            </button>
                        </div>
                    </div>
                    <hr>
                    <div class="elements-space-between" data-toggle="collapse" data-target="#supplier_adv_search">
                        <span class="h5">Advanced Search</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="supplier_adv_search" class="advanced-search-collapse collapse">
                        <div class="row">
                            <div class="col-md">
                              <label for="">Email</label>
                                <input type="text" class="form-control" id="email" name="email">
                            </div>
                            <div class="col-md">
                                <label for="">Supplier Type</label>
                                <select type="text" class="form-control" id="supplier_type" name="supplier_type">
                                    <option value="">select</option>
                                    {% for suptype in dropdown_suptype_values %}
                                        <option value="{{suptype.field_type_id}}">{{suptype.field_type_desc}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md">
                                <label for="">Country</label>
                                <select name="country_code" id="country_code" class="form-control">
                                    <option value="">select</option>
                                    {% for countries in get_country_id %}
                                    <option value="{{countries.country_code}}">{{countries.country_code}} - {{countries.country_name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md">
                                <label for="">City</label>
                                <input type="text" class="form-control check_for_search" id="city" name="city">
                            </div>
                            <div class="col-md">
                                <label for="">Purchasing Organization</label>
                                <select name="purchasing_org" id="porg" class="form-control">
                                    <option value="">select</option>
                                    {% for porg in purch_org_list %}
                                    <option value="{{porg}}">{{porg}}</option>
                                    {% endfor %}
                                </select>
                                <small id="porg_change" class="form-text text-muted help-text-porg_dropdown" hidden></small>
                            </div>
                            <div class="col-md">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="block" id="purchase_block">
                                    <label class="form-check-label" for="">
                                        Purchase Block
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="elements-space-between">
                        <input type="reset" value="Clear filters" class="ip-form-clear-filters">

                    </div>
                </form>
            </div>
        </div>

        {% if supplier_results.count > 0 %}
        <div class="search_result_count_card card">
            <div class="card-body">
                <h6 class="card-title">Total number of results found
                    :{{supplier_results.count}}</h6>
            </div>
        </div>
        {% elif supplier_results.count == 0  %}
        <div class="search_result_count_card card">
            <div class="card-body">
                <h6 class="card-title">No Results Found</h6>
            </div>
        </div>
        {% endif %}

        <div id="error_msg_div" class="alert alert-success" hidden><span id="success_msg_id"></span></div>

        {% if supplier_results %}
        
        <div class="card mt-5">
            <div>
                <button class="btn btn-primary btn-sm mt-2 ml-2" title="Delete" id="id_delete_supplier" value="product_delete" data-toggle="modal" data-target="#id_delete_confirm_popup" style="display:none;">
                    <i class="fa fa-trash"></i> Delete
                </button>
                <div>
                    <table id="sup_tab" class="table table_sort_filter_export_excel">
                        <thead class="thead-light">
                        <tr>
<!--                            <th scope="col"> <input type="checkbox" onclick="checkAll(this)"></th>-->
                            <th id="hg_select_checkbox" scope="col"> <div id="id_check_all"> <input type="checkbox" id="selectAll" onclick="checkAll(this)"></div></th>
                            <th> Supplier Number  </th>
                            <th> First Name </th>
                            <th> Last Name </th>
                            <th> City </th>
                            <th> Email</th>
                            <th> Supplier Status</th>
                            <th> Country</th>
                            <th> Registration Number</th>
                            <th> Purchase Block</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="supplier_detail_tbody">
                        {% for results in supplier_results %}
                        <tr id="table-{{results.supplier_id}}">
                            <td><input type="checkbox" class="supplier_checkbox" onclick="valueChanged();"></td>
                            <td><a href="{% url 'eProc_Admin_Tool:sup_details_page' results.supplier_id_encrypted %}" id="{{results.supplier_id}}" class="deletepop" target="_blank">{{results.supplier_id}}</a></td>
                            <td>{{results.name1}}</td>
                            <td>{{results.name2}}</td>
                            <td>{{results.city}}</td>
                            <td>{{results.email}}</td>
                            <td>
                                {% if results.is_active %}
                                Active
                                {% else %}
                                Inactive
                                {% endif %}
                            </td>
                            <td>{{results.country_code_id}}</td>
                            <td>{{results.registration_number}}</td>
                            <td>
                                <label class="switch">
                                    <label class="toggle-control">
                                        {% if results.block %}
                                        <input type="checkbox" id="{{results.supplier_id}}-block" class="toggle-block" checked>
                                        <span class="control"></span>
                                        {% else %}
                                        <input type="checkbox" id="{{results.supplier_id}}-unblock" class="toggle-block">
                                        <span class="control"></span>
                                        {% endif %}
<!--                                        <div class="toggle-controller default-success"></div>-->
                                    </label>
                                </label>
                            </td>
                            <td class="item-action-icon-section">
<!--                                <i class="fas fa-trash-alt hg-icon-blue-primary" title="Delete User" id="{{results.supp_guid}}-{{results.supplier_id}}" onclick="get_supplier_detail_to_delete(this.id)"></i>-->
                                 <span title="Delete supplier" onclick="get_supplier_detail_to_delete(this.id)" id="{{results.supp_guid}}-{{results.supplier_id}}">
                                    <i class="material-icons item-action-icons">delete_outline</i>
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!--modal popup for user delete-->
<div class="modal fade" id="confirm_delete_pop_up" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Please Confirm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                You are about to delete form "<span id="form_id_del"></span>". Are you sure?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="delete_supplier('individual')">Delete</button>
            </div>
        </div>
    </div>
</div>

<!--change confirmation popup-->
    <div class="modal fade" id="id_block_confirm_popup" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" >
                    <h5 class="modal-title">Please Confirm</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to Change?.</p>
                </div>
                <div class="modal-footer">
<!--                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal" onclick="reload_previous_state()"><i class="fas fa-times"></i> cancel</button>-->
<!--                    <button type="button" onclick="lock_active_change()" class="btn btn-primary"><i class="fas fa-check"></i> yes </button>-->
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal" onclick="toggle()"><i class="fas fa-times"></i> cancel</button>
                    <button type="button" onclick="block_unblock_supplier();" class="btn btn-primary"><i class="fas fa-check"></i> yes </button>
                </div>
            </div>
        </div>
    </div>
    <!--end of delete confirmation popup-->

<!--delete confirmation popup-->
<div class="modal fade" id="id_delete_confirm_popup">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" >
                <h5 class="modal-title">Please Confirm</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete?.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-dismiss="modal"><i class="fas fa-times"></i> cancel</button>
                <button type="button" onclick="delete_supplier()" class="btn btn-primary"><i class="fas fa-check"></i> yes </button>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'scripts/supplier-search.js' %}"> </script>
<script>
    var GLOBAL_SUPPLIER_GUID = '';

    function reload(){
        localStorage.setItem("fname", document.getElementById("name1").value);
        localStorage.setItem("lname", document.getElementById("name2").value);
        localStorage.setItem("supp_id", document.getElementById("supplier_id").value);
        localStorage.setItem("supp_email", document.getElementById("email").value);
        localStorage.setItem("supp_type", document.getElementById("supplier_type").value);
        localStorage.setItem("city_code", document.getElementById("city").value);
        localStorage.setItem("country_id", document.getElementById("country_code").value);
        localStorage.setItem("supp_porg", document.getElementById("porg").value);
        localStorage.setItem("supp_purchase_block", document.getElementById("purchase_block").checked);
        OpenLoaderPopup();
    }

    //onclick of upload button display id_data_upload popup and set GLOBAL_ACTION button value
    function onclick_upload_button() {
        GLOBAL_ACTION = "supplier_upload"
        $("#id_popup_tbody").empty();
        $('#id_data_upload').modal('show');
    }

    function get_supplier_detail_to_delete(element) {
        data_delete = element.split('-');
        GLOBAL_SUPPLIER_GUID = data_delete[0]
        document.getElementById("form_id_del").innerHTML = data_delete[1];
        $('#confirm_delete_pop_up').modal('show')
    }

    // Function to delete User
    function delete_supplier(action) {
        $('#confirm_delete_pop_up').modal('hide');
        $('#id_delete_confirm_popup').modal('hide');
        if(action == 'individual'){
            var user_data = [data_delete[1]]
            data = {'data':user_data}
        }else{
            main_table_product_checked = [];
            $("#sup_tab TBODY TR").each(function () {
                var row = $(this);
                var abc = row[0].id
                var supplier_id = abc.split('-')[1]
                var country_arr_obj ={};
                var check_status = row.find("TD").eq(0).find('input[type="checkbox"]').is(':checked');
                if(check_status){
                    main_table_product_checked.push(supplier_id);
                }
            });
              $('#confirm_delete_pop_up').modal('hide');
            data = {'data':main_table_product_checked}
        }
        OpenLoaderPopup();
        $.ajax({
            type: 'POST',
            url: "{% url 'eProc_Suppliers:delete_supplier' %}",
            data:JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (Response) {
            display_supplier_data(Response.supplier_results);
            $('#success_msg_id').text(Response.success_message);
            $("#error_msg_div").prop("hidden",false);
<!--            message_display_time();-->
            CloseLoaderPopup();
            }
        });
    }

    var data = {}
    var block_id = '';
    $('.toggle-block').change(function() {
        if($(this).is(':checked')) {
            $('.toggle-off').removeClass('active');
            $('.toggle-on').addClass('active');
            data.flag = true
        } else {
            $('.toggle-off').addClass('active');
            $('.toggle-on').removeClass('active');
            data.flag = false
        }
        var id = this.id
        block_id = id
        data.supplier_id = id.split('-')[0]
        $('#id_block_confirm_popup').modal('show');
    });

    function block_unblock_supplier(){
        OpenLoaderPopup();
        jQuery.ajax({
            type: 'POST',
            url: "{% url 'eProc_Suppliers:supplier_blocking' %}",
            dataType :'json',
            data: JSON.stringify(data),
            success: function(response){
                    $('#id_block_confirm_popup').modal('hide');
                     $('#success_msg_id').text(response.success_message);
                    $("#error_msg_div").prop("hidden",false)
<!--                    message_display_time();-->
                    CloseLoaderPopup();
            },
            error: function(xhr, resp, text) {
            },
            cache: false,
            processData: false,
            contentType: false,
        });
    }

    function toggle(){
        var abc = $('#'+block_id)
        if($('#'+block_id).is(':checked')) {
            $('#'+block_id).prop("checked", false);
        }
        else{
            $('#'+block_id).prop("checked", true);
        }
    }
    //onclick of select all checkbox
    function checkAll1(ele) {
        if (ele.checked) {
            $('.supplier_checkbox').each(function() {
                var disable_check = this.disabled
                if(disable_check == false){
                    this.checked = true;
                    $("#id_delete_supplier").show();
                }
            });
        }
        else{
            $('.supplier_checkbox').each(function() {
                var disable_check = this.disabled
                if(disable_check == false){
                    this.checked = false;
                    $("#id_delete_supplier").hide();
                }
            });
        }
    }

    function valueChanged() {
        if ($('.supplier_checkbox').is(":checked")) {
            $("#id_delete_supplier").show();
        } else {
            $("#id_delete_supplier").hide();
        }
    }

    function display_supplier_data(supplier_data){
        var supplier_detail_html = '';
        var is_active = '';
        var block_input = '';
        $('#sup_tab').DataTable().destroy();
        $("#supplier_detail_tbody").empty();
        $.each(supplier_data, function (i, supplier_detail) {
            if(supplier_detail.is_active){
                is_active = 'Active'
            }
            else{
                is_active = 'Inactive'
            }
            if(supplier_detail.block){
                block_input = '<input type="checkbox" id="'+supplier_detail.supplier_id+'-block" class="toggle-block dummy_supplier_block" checked><span class="control"></span>'
            }
            else{
                block_input = '<input type="checkbox" id="'+supplier_detail.supplier_id+'-unblock" class="toggle-block dummy_supplier_block"><span class="control"></span>'
            }
            supplier_detail_html += '<tr id="'+supplier_detail.supplier_id+'">'+
                    '<td><input type="checkbox" class="supplier_checkbox" onclick="valueChanged();"></td>'+
                    '<td><a href="#" class="dummy_supplier_detail"  id="'+supplier_detail.supplier_id_encrypted+'" target="_blank">'+supplier_detail.supplier_id+'</a></td>'+
                    '<td>'+ supplier_detail.name1 +'</td>'+
                    '<td> '+ supplier_detail.name2 +'</td>'+
                    '<td>'+ supplier_detail.city +'</td>'+
                    '<td>'+ supplier_detail.email +'</td>'+
                    '<td>'+ is_active +'</td>'+
                    '<td> '+ supplier_detail.country_code_id +'</td>'+
                    '<td>'+ supplier_detail.registration_number +'</td>'+
                    '<td><label class="switch"><label class="toggle-control">'+ block_input +'</label></label></td>'+
                    '<td class="item-action-icon-section"><span title="Delete supplier" onclick="get_supplier_detail_to_delete(this.id)" id="'+ supplier_detail.supp_guid +'-'+ supplier_detail.supplier_id +'" data-toggle="modal"  data-target="#confirm_delete_pop_up" onclick="get_supplier_detail_to_delete(this.id)">'+
                        '<i class="material-icons item-action-icons">delete_outline</i></span></td>'+
                    '</tr>';
        });
        $("#supplier_detail_tbody").append(supplier_detail_html);
        table_sort_filter('sup_tab');
    }

    $(document).on('click', '.dummy_supplier_detail', function () {
        var url = "{% url 'eProc_Admin_Tool:sup_details_page' 123 %}";
        var id = $(this).attr('id');
        var href_link = url.replace('123', id)
        window.open(href_link,'_blank');
    });
     $(document).on('click', '.dummy_supplier_block', function () {
        var id = this.id
        block_id = id
        data.supplier_id = id.split('-')[0];
        $('#id_block_confirm_popup').modal('show');
    });


    <!-- ----------------------------------------------------   -->
var table = $('#sup_tab').DataTable();
 var rows_selected = [];
//onclick of select all checkbox
$('#sup_tab tbody').on('click', 'input[class="supplier_checkbox"]', function(e){
      var $row = $(this).closest('tr');
      // Get row data
      var data = table.row($row).data();
      // Get row ID
      var rowId = data[0];
      // Determine whether row ID is in the list of selected row IDs
      var index = $.inArray(rowId, rows_selected);
      // If checkbox is checked and row ID is not in list of selected row IDs
      if(this.checked && index === -1){
         rows_selected.push(rowId);
      // Otherwise, if checkbox is not checked and row ID is in list of selected row IDs
      } else if (!this.checked && index !== -1){
         rows_selected.splice(index, 1);
      }
      if(this.checked){
         $row.addClass('selected');
      } else {
         $row.removeClass('selected');
      }
      // Update state of "Select all" control
//      updateDataTableSelectAllCtrl(table);
      // Prevent click event from propagating to parent
      e.stopPropagation();
   });

   // Handle click on "Select all" control
   $('thead input[id="selectAll"]', table.table().container()).on('click', function(e){
      if(this.checked){
         $('#sup_tab tbody input[class="supplier_checkbox"]:not(:checked)').trigger('click');
      } else {
         $('#sup_tab tbody input[class="supplier_checkbox"]:checked').trigger('click');
      }
      // Prevent click event from propagating to parent
      e.stopPropagation();
   });
   // Handle table draw event
   table.on('draw', function(){
      // Update state of "Select all" control
      updateDataTableSelectAllCtrl(table);
      valueChanged();
//      e.stopPropagation();
   });
    function updateDataTableSelectAllCtrl(table){
       var $table             = table.table().node();
       var $chkbox_all        = $('tbody input[class="supplier_checkbox"]', $table);
       var $chkbox_checked    = $('tbody input[class="supplier_checkbox"]:checked', $table);
       var chkbox_select_all  = $('thead input[id="selectAll"]', $table).get(0);

       // If none of the checkboxes are checked
       if($chkbox_checked.length === 0){
          chkbox_select_all.checked = false;
          if('indeterminate' in chkbox_select_all){
             chkbox_select_all.indeterminate = false;
          }
       // If all of the checkboxes are checked
       } else if ($chkbox_checked.length === $chkbox_all.length){
          chkbox_select_all.checked = true;
          if('indeterminate' in chkbox_select_all){
             chkbox_select_all.indeterminate = false;
          }
       } else {
          chkbox_select_all.checked = true;
          if('indeterminate' in chkbox_select_all){
             chkbox_select_all.indeterminate = true;
          }
   }
}


</script>

{% endblock %}