{% extends 'root/base.html' %}
{% load static %}

{% block title %} Organizational Announcements (Admin Tool) {% endblock %}
{% block maincontent %}
<style>
    /* Increase the width and height of the modal */
    .modal-dialog {
        max-width: 800px; /* Adjust the width as needed */
        max-height: 600px; /* Adjust the height as needed */
    }
</style>

<div class="container-fluid">
    <div class="mep-form_wrapper">

        <div class="d-flex justify-content-between">
            <h3>Organizational Announcements</h3>
            <div>
<button class="btn btn-primary" data-toggle="modal" data-target="#saveConfirmationModal">
    <i class="fas fa-user-plus"></i> Add New Announcement
</button>

            </div>
        </div>

        <hr>

        <div class="card card-shadow-1">
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md">
                            <label for="">Title/Description</label>
                            <input type="text" class="form-control check_for_search" id="announcement_subject"
                                name="announcement_subject">
                                <small class="form-text text-muted">Use * as a wild card search criteria (eg. Apple - App*, *ple, *ppl*</small>
                        </div>
                        <div class="col-md">
                            <label for="">Status</label>
                            <select type="text" class="form-control" id="announcement_status" name="status">
                                {% for status in status_dropdown_values %}<option value="{{ status }}"> {{ status }}
                                </option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md">
                            <label for="">Priority</label>
                            <select type="text" class="form-control" id="priority" name='priority'>
                                {% for priority in priority_dropdown_values %}<option value="{{ priority }}"> {{ priority }}
                                </option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-auto my-1">
<button class="button-search-users btn btn-primary" type="submit" title="Please click to get the search details!"
    onclick="saveDataToLocalStorage();">
    <i class="fas fa-search"></i> search
</button>

                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
<input type="reset" value="Clear filters" class="ip-form-clear-filters btn btn-link" onclick="clearFilters()">
                        </div>
                    </div>
                </form>
            </div>
        </div>

     <!-- {% if announcement_result1.count > 0 %}
        <div class="search_result_count_card card">
            <div class="card-body">
                <h6 class="card-title">Total number of results found
                    :{{announcement_result1.count}}</h6>
            </div>
        </div>
        {% elif announcement_result1.count == 0  %}
        <div class="search_result_count_card card">
            <div class="card-body">
                <h6 class="card-title">No Results Found</h6>
            </div>
        </div>
        {% endif %} -->
    <div class="alert alert-success display-none" id="org_announcement_update_success" role="alert"> </div>
    <div style="margin-top:25px" id="error_msg_div" class="alert alert-success" hidden><span id="success_msg_id"></span></div>

    {% if announcement_result1 %}
    <div class="card mt-5">
        <div>
            <button class="btn btn-primary  btn-sm mt-2 ml-2" title="Delete" id="id_delete_annsmt" value="annsmt_delete"
                data-toggle="modal" data-target="#id_delete_confirm_popup" style="display:none;">
                <i class="fa fa-trash"></i> delete
            </button>
            <div>
                <table id="sup_tab" class="table qwsqwsqws">
                    <thead class="thead-light">
                        <tr>
                            <th id="hg_select_checkbox" scope="col"> <div id="id_check_all"> <input type="checkbox" id="selectAll" onclick="checkAll(this)"></div></th>
                            <th hidden> GUID </th>
                            <th> Announcement Number </th>
                            <th> Title </th>
                            <th> DESCRIPTION </th>
                            <th> STATUS </th>
                            <th> PRIORITY </th>
                            <th> FROM DATE</th>
                            <th> TO DATE</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="sup_tab_body">

                        {% for results in announcement_result1 %}

                        <tr id="tr_{{results.announcement_subject}}">
                            <td class="class_select_checkbox"><input type="checkbox" class="annsmt_checkbox" onclick="valueChanged();"></td>
                            <td hidden>{{results.unique_announcement_id}}</td>
                            <td><a style="color: #049ca2;"
                                    href="{% url 'eProc_Admin_Tool:org_announcement_details' results.unique_announcement_id %}"
                                    id="{{results.unique_announcement_id}}" class="org-table-action-icon"
                                    target="_blank">{{results.announcement_id}}</a> </td>
                            <td>{{results.announcement_subject}} </td>
                            <td>{{results.announcement_description}}</td>
                            <td>{{results.status}}</td>
                            <td>{{results.priority}}</td>
                            <td>{{results.announcement_from_date|date:'d-m-Y'}}</td>
                            <td>{{results.announcement_to_date|date:'d-m-Y'}}</td>
                            <td class="item-action-icon-section">
                                <span title="Delete Announcement" onclick="get_annsmt_detail_to_delete(this.id)" id="{{results.unique_announcement_id}}">
                                <i class="material-icons item-action-icons"
                                     >delete_outline</i>
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
</div>

<!-- Custom Modal Popup for Save Confirmation -->
<div class="modal fade" id="saveConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="saveConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveConfirmationModalLabel">Organizational Announcement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card card-shadow-1">
                    <div class="card-body">
<!--                        <h5 class="card-title">Organizational Announcement</h5>-->
                        <div class="row">
                            <input value="{{announcement_details.unique_announcement_id}}" id="announcement_guid" hidden>
                            <input type="text" id="announcement_id" value="{{announcement_details.announcement_id}}" hidden>

                            <div class="form-group col-md">
                                <label> Title</label><span class="hg_required"></span><br>
<input type="text" class="form-control hg_edit_display_mode check_special_char" id="modal_announcement_subject" value="{{announcement_details.announcement_subject}}" required>
                                <small class="form-text text-muted">Valid characters are A-Z a-z 0-9</small>
                            </div>

                            <div class="form-group col-md">
                                <label> Description</label><span class="hg_required"></span><br>
                                <input type="text" name="announcement_desc" id="announcement_desc" class="form-control hg_edit_display_mode check_special_char" value="{{announcement_details.announcement_description}}" required>
                                <small class="form-text text-muted">Valid characters are A-Z a-z 0-9</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md">
                                <label> Status</label><br>
                            <select type="text" class="form-control" id="announcement_status" name="status">
                                {% for status in status_dropdown_values %}<option value="{{ status }}"> {{ status }}
                                </option>{% endfor %}
                            </select>
                            </div>

                            <div class="form-group col-md">
                                <label> Priority</label><br>
                            <select type="text" class="form-control" id="priority" name='priority'>
                                {% for priority in priority_dropdown_values %}<option value="{{ priority }}"> {{ priority }}
                                </option>{% endfor %}
                            </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md">
                                <label> From Date</label><span class="hg_required"></span><br>
                                <input type="date" class="form-control hg_edit_display_mode" name="from_date" id="from_date" value="{{from_date}}" required>
                            </div>

                            <div class="form-group col-md">
                                <label> To Date</label><span class="hg_required"></span><br>
                                <input type="date" class="form-control hg_edit_display_mode" name="to_date" id="to_date" value="{{to_date}}" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                    <div id="org_save_button">
                        <button class="btn btn-primary" type="button" title="Click here to Register" onclick="save_announcement_data();"><i class="fas fa-check"></i>  save</button>
                    </div>
                                    <div id="org_edit_button" class="display-none">
                        <button type="button" class="btn btn-primary" onclick="edit_org_announcement_data();"><i class="far fa-edit"></i> edit</button>
                    </div>
            </div>
        </div>
    </div>
</div>


<!--</div>-->
<!--modal popup for announcement delete-->
<div class="modal fade" id="confirm_delete_pop_up" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Please Confirm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                You are about to delete "<span id="form_id_del"></span>". Are you sure?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="delete_announcement()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!--delete confirmation popup-->
<div class="modal fade" id="id_delete_confirm_popup">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Please Confirm</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete?.</p>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="main_table_delete()" class="btn btn-primary"><i class="fas fa-check"></i>
                    yes </button>
                <button type="button" class="btn btn-primary" data-dismiss="modal"><i class="fas fa-times"></i>
                    Cancel</button>
            </div>
        </div>
    </div>
</div>
<!--end of delete confirmation popup-->

<script>

    $(document).ready(function () {
        nav_bar_admin();
        console.log(document.getElementById("announcement_subject").value);
        document.getElementById("announcement_subject").value = "";
        table_sort_filter_basic("qwsqwsqws")
    });

        // Function to store form data in localStorage
    function saveDataToLocalStorage() {
        localStorage.setItem("announcement_subject", document.getElementById("announcement_subject").value);
        localStorage.setItem("announcement_status", document.getElementById("announcement_status").value);
        localStorage.setItem("priority", document.getElementById("priority").value);
    }

    // Function to set input fields from localStorage
    function setFieldsFromLocalStorage() {
        document.getElementById("announcement_subject").value = localStorage.getItem("announcement_subject");
        document.getElementById("announcement_status").value = localStorage.getItem("announcement_status");
        document.getElementById("priority").value = localStorage.getItem("priority");
    }

    // Call the function to set input fields from localStorage when the page loads.
    window.onload = function() {
        setFieldsFromLocalStorage();
    };

    function reload() {
        setFieldsFromLocalStorage();
        OpenLoaderPopup();
    }

    // Function to clear filters and clear localStorage data
    function clearFilters() {
        document.getElementById("announcementForm").reset();
        localStorage.removeItem("announcement_subject");
        localStorage.removeItem("announcement_status");
        localStorage.removeItem("priority");
        reload();
    }


    $('#search_announcements_button').click(function () {
        OpenLoaderPopup();
    })


    function get_annsmt_detail_to_delete(element) {
        data_delete = element;
        document.getElementById("form_id_del").innerHTML = data_delete;
        $('#confirm_delete_pop_up').modal('show')
    }

    // Function to delete announcement
    function delete_announcement() {
        var annsmt_info = [];
        annsmt_info.push(data_delete);
        $('#confirm_delete_pop_up').modal('hide');
        data = annsmt_info;
        $.ajax({
            type: 'POST',
            url: "{% url 'eProc_Admin_Tool:delete_org_announcement' %}",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (Response) {
                display_annsmt_data(Response.announcement_result1);
                $('#success_msg_id').text(Response.success_message);
                $("#error_msg_div").prop("hidden", false);
                window.location.reload();
                CloseLoaderPopup();
            }
        });
    }


function display_annsmt_data(annsmt_data) {
    var org_annsmt_html = '';
    $('#sup_tab').DataTable().destroy();
    $("#sup_tab_body").empty();

    $.each(annsmt_data, function (i, annsmt) {
        if (annsmt.announcement_id) {
            checkbox_input = '<input type="checkbox" class="annsmt_checkbox" onclick="valueChanged()"  >';
        } else {
            checkbox_input = '<input type="checkbox" class="annsmt_checkbox" onclick="valueChanged()" >';
        }

        const date1 = new Date(annsmt.announcement_from_date);
        const date2 = new Date(annsmt.announcement_to_date);
        // get the date as a string in the format dd-mm-yyyy
        const from_date = ("0" + date1.getDate()).slice(-2) + "-" + ("0" + (date1.getMonth() + 1)).slice(-2) + "-" + date1.getFullYear();
        const to_date = ("0" + date2.getDate()).slice(-2) + "-" + ("0" + (date2.getMonth() + 1)).slice(-2) + "-" + date2.getFullYear();

        org_annsmt_html += '<tr id="' + annsmt.announcement_id + '"><td class="class_select_checkbox">' + checkbox_input + '</td> ' +
            '<td hidden>' + annsmt.unique_announcement_id + '</td>' +
            '<td><a href="#" id="' + annsmt.announcement_id + '" class="org-table-action-icon" target="_blank">' + annsmt.announcement_id + '</a></td>' +
            '<td>' + annsmt.announcement_subject + '</td>' +
            '<td>' + annsmt.announcement_description + '</td>' +
            '<td>' + annsmt.status + '</td>' +
            '<td>' + annsmt.priority + '</td>' +
            '<td>' + from_date + '</td>' +
            '<td>' + to_date + '</td>' +
            '<td class="item-action-icon-section"><span title="Delete Announcement" onclick="get_annsmt_detail_to_delete(this.id)" id="' + annsmt.announcement_id + '">' +
    '<i class="material-icons item-action-icons">delete_outline</i></span></td></tr>';
    });
    $("#sup_tab_body").append(org_annsmt_html);
    table_sort_filter('sup_tab');
}




// Function to display success message and hide it after 5 seconds (optional)
function message_display_time() {
    $("#error_msg_div").prop("hidden", false);
    setTimeout(function () {
        $("#error_msg_div").prop("hidden", true);
    }, 5000); // Hide after 5 seconds (adjust as needed)
}

    function main_table_delete() {
        main_table_annsmt_checked = [];
        $("#sup_tab TBODY TR").each(function () {
            var row = $(this);
            var abc = row.find("TD").eq(1).html();;
            console.log(abc);
            var country_arr_obj = {};
            var check_status = row.find("TD").eq(0).find('input[type="checkbox"]').is(':checked');
            if (check_status) {
                main_table_annsmt_checked.push(abc);
            }
        });
        $('#id_delete_confirm_popup').modal('hide');
        console.log(main_table_annsmt_checked);
        data = main_table_annsmt_checked
        OpenLoaderPopup();
        $.ajax({
            type: 'POST',
            url: "{% url 'eProc_Admin_Tool:delete_org_announcement' %}",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (Response) {
                display_annsmt_data(Response.announcement_result1);
                    $('#success_msg_id').text(Response.success_message)
<!--                $("#id_delete_annsmt").hide();-->
                $("#error_msg_div").prop("hidden", false)
<!--                setTimeout(function () { $("#error_msg_div").prop("hidden", true); }, 5000)-->
                message_display_time();

                window.location.reload();
                CloseLoaderPopup();
            }
        });
    }



    function valueChanged() {
        if ($('.annsmt_checkbox').is(":checked")) {
            $("#id_delete_annsmt").show();
        } else {
            $("#id_delete_annsmt").hide();
        }
    }

        //onclick of select all checkbox
    function checkAll(ele) {
        if (ele.checked) {
            $('.annsmt_checkbox').each(function() {
                var disable_check = this.disabled
                if(disable_check == false){
                    this.checked = true;
                    $("#id_delete_annsmt").show();
                }
            });
        }
        else{
            $('.annsmt_checkbox').each(function() {
                var disable_check = this.disabled
                if(disable_check == false){
                    this.checked = false;
                    $("#id_delete_annsmt").hide();
                }
            });
        }
    }

    <!--Check All -->
<!-- ----------------------------------------------------   -->
var table = $('#sup_tab').DataTable();
 var rows_selected = [];
 //onclick of select all checkbox
$('#sup_tab tbody').on('click', 'input[class="annsmt_checkbox"]', function(e){
      var $row = $(this).closest('tr');
      // Get row data
      var data = table.row($row).data();
      // Get row ID
      var rowId = data[0];
      // Determine whether row ID is in the list of selected row IDs
      var index = $.inArray(rowId, rows_selected);
      // If checkbox is checked and row ID is not in list of selected row IDs
      if(this.checked && index === -1){
         rows_selected.push(rowId);
      // Otherwise, if checkbox is not checked and row ID is in list of selected row IDs
      } else if (!this.checked && index !== -1){
         rows_selected.splice(index, 1);
      }
      if(this.checked){
         $row.addClass('selected');
      } else {
         $row.removeClass('selected');
      }
      // Update state of "Select all" control
//      updateDataTableSelectAllCtrl(table);
      // Prevent click event from propagating to parent
      e.stopPropagation();
   });

   // Handle click on "Select all" control
   $('thead input[id="selectAll"]', table.table().container()).on('click', function(e){
      if(this.checked){
         $('#sup_tab tbody input[class="annsmt_checkbox"]:not(:checked)').trigger('click');
         $(".annsmt_checkbox").prop("checked", true);
      } else {
         $('#sup_tab tbody input[class="annsmt_checkbox"]:checked').trigger('click');
         $(".annsmt_checkbox").prop("checked", false);
      }
      // Prevent click event from propagating to parent
      e.stopPropagation();
   });
   // Handle table draw event
   table.on('draw', function(){
      // Update state of "Select all" control
      updateDataTableSelectAllCtrl(table);
      valueChanged();
//      e.stopPropagation();
   });
    function updateDataTableSelectAllCtrl(table){
       var $table             = table.table().node();
       var $chkbox_all        = $('tbody input[class="annsmt_checkbox"]', $table);
       var $chkbox_checked    = $('tbody input[class="annsmt_checkbox"]:checked', $table);
       var chkbox_select_all  = $('thead input[id="selectAll"]', $table).get(0);

       // If none of the checkboxes are checked
       if($chkbox_checked.length === 0){
          chkbox_select_all.checked = false;
          if('indeterminate' in chkbox_select_all){
             chkbox_select_all.indeterminate = false;
          }
       // If all of the checkboxes are checked
       } else if ($chkbox_checked.length === $chkbox_all.length){
          chkbox_select_all.checked = true;
          if('indeterminate' in chkbox_select_all){
             chkbox_select_all.indeterminate = false;
          }
       } else {
          chkbox_select_all.checked = true;
          if('indeterminate' in chkbox_select_all){
             chkbox_select_all.indeterminate = true;
          }
   }
}

 function save_announcement_data() {
        var sub_val = $('#modal_announcement_subject').val();

        console.log('Title Value:', sub_val);
        var desc_val = $('#announcement_desc').val();
        var from_date_val = $('#from_date').val();
        var to_date_val = $('#to_date').val();
        is_save_form_valid = save_announcement_form_validation(sub_val, desc_val, from_date_val, to_date_val)
        if (is_save_form_valid != '') {
            $('#save_error_div').html(is_save_form_valid)
            $('#save_error_div').show()
            scroll_top();
            return
        }

        var form_data = {};
        form_data = {
            announcement_id: document.getElementById('announcement_id').value,
            announcement_subject: document.getElementById('modal_announcement_subject').value,
            announcement_description: document.getElementById('announcement_desc').value,
            status: document.getElementById('announcement_status').value,
            priority: document.getElementById('priority').value,
            announcement_from_date: document.getElementById('from_date').value,
            announcement_to_date: document.getElementById('to_date').value,
            announcement_guid: document.getElementById('announcement_guid').value,
        }
        OpenLoaderPopup();

        $.ajax({
            type: 'POST',
            url: "{% url 'eProc_Org_Support:org_announcement_save' %}",
            data: JSON.stringify(form_data),
            success: function (response) {
                 $('#saveConfirmationModal').modal('hide');
                document.getElementById('org_announcement_update_success').innerHTML = response.message;
                //console.log(response.updated_guid)
                $('#save_error_div').hide();
                $('#org_announcement_update_success').show();
                $('html, body').animate({ scrollTop: 0 }, 'slow');
                document.getElementById('announcement_guid').value = response.updated_guid;
                document.getElementById('org_save_button').style.display = 'none';
                document.getElementById('org_edit_button').style.display = 'block';
                $(".hg_edit_display_mode").prop("disabled", true);
                CloseLoaderPopup();
            }
        });

    }

 // Validation function
    const save_announcement_form_validation = (sub, desc, from_date, to_date) => {
        var is_valid = true
        var save_form_errors = ''
        var mailformat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
        if (sub == '') {
            is_valid = false
            save_form_errors += messageConstants["JMSG007"] + "Announcement Subject";
        }
        else if (desc == '') {
            is_valid = false
            save_form_errors += messageConstants["JMSG007"] + "Announcement Description";
        }
        else if (from_date == '') {
            if ((Date.parse(to_date) < Date.parse(from_date)) == false) {
                is_valid = false
                save_form_errors += messageConstants["JMSG007"] + "Announcement From Date";
            }
        }
        else if (to_date == '') {
            is_valid = false
            save_form_errors += messageConstants["JMSG007"] + "Announcement To Date";
        }


        return is_valid, save_form_errors
    }


</script>

{% endblock %}